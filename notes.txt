// This function waits for the 'fd' object to be ready before running our main code.
function runWhenFDReady() {
    if (typeof fd !== 'undefined' && fd.spRendered) {
        // --- All of our original code goes here ---

        fd.spRendered(function() {
            console.log("InfoWise Form Ready. Setting up lookups...");

            // This function will perform the lookup
            function getRating(sourceFieldName, keyPart, targetFieldName) {
                console.log("-----\nRunning getRating for: " + targetFieldName);
                
                var fieldValue = fd.field(sourceFieldName).value();
                // --- DEBUG: Print the value of the source field ---
                console.log("Source Field '" + sourceFieldName + "' Value: ", fieldValue);

                if (!fieldValue) {
                    console.log("Source field is empty. Setting target to 0.");
                    fd.field(targetFieldName).value(0);
                    return;
                }

                var lookupKey = "Discovery|" + keyPart + "|" + fieldValue;
                // --- DEBUG: Print the key we are looking for ---
                console.log("Constructed Lookup Key: " + lookupKey);

                var apiUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Charter Ratings')/items?$filter=LookupKey eq '" + lookupKey + "'";
                // --- DEBUG: Print the exact URL we are querying ---
                console.log("API URL: " + apiUrl);

                $.ajax({
                    url: apiUrl,
                    method: "GET",
                    headers: { "Accept": "application/json; odata=verbose" },
                    success: function (data) {
                        console.log("API call successful for " + targetFieldName, data.d.results);
                        var score = 0;
                        if (data.d.results.length > 0) {
                            var lookedUpValue = data.d.results[0].Value;
                            console.log("Found value: " + lookedUpValue);
                            var parsedValue = parseFloat(String(lookedUpValue).trim());
                            if (!isNaN(parsedValue)) {
                                score = parsedValue;
                            }
                        } else {
                            console.log("No items found for this key.");
                        }
                        console.log("Setting '" + targetFieldName + "' to: " + score);
                        fd.field(targetFieldName).value(score);
                    },
                    error: function (error) {
                        console.error("API Error for " + targetFieldName + ": " + JSON.stringify(error));
                        fd.field(targetFieldName).value(0);
                    }
                });
            }

            // This function runs all the rating calculations
            function calculateAllRatings() {
                console.log("calculateAllRatings triggered.");
                getRating('Compliance / Quality', 'Compliance / Quality', 'CompQualScoreCalc');
                getRating('Performance', 'Performance', 'PerfScoreCalc');
                getRating('Contract Mod', 'Contract Mod', 'ContractModScoreCalc');
                getRating('Growth', 'Growth (Organic and New Business):', 'GrowthScoreCalc');
                getRating('Customer Experience', 'Customer Experience', 'CustExpScoreCalc');
                getRating('CBA Net Cost', 'CBA Net Cost', 'CBANetCostScoreCalc');
            }

            // --- SETUP FOR YOUR SCORE FIELDS ---
            var projectLookupField = 'Project Lookup'; 

            fd.field(projectLookupField).$on('change', function() {
                console.log("Project Lookup field changed.");
                setTimeout(calculateAllRatings, 500);
            });

            setTimeout(calculateAllRatings, 500);
        });

    } else {
        setTimeout(runWhenFDReady, 100);
    }
}

// Start the process
runWhenFDReady();

// Wait for the 'fd' object to be ready before running.
function runWhenFDReady() {
    if (typeof fd !== 'undefined' && fd.spRendered) {

        // Use the InfoWise framework to run code when the form is ready
        fd.spRendered(function() {

            // This function will perform the lookup
            function getRating(sourceFieldName, keyPart, targetFieldName) {
                var fieldValue = fd.field(sourceFieldName).value();
                if (!fieldValue) {
                    fd.field(targetFieldName).value(0);
                    return;
                }
                var lookupKey = "Discovery|" + keyPart + "|" + fieldValue;
                var apiUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Charter Ratings')/items?$filter=LookupKey eq '" + lookupKey + "'";

                $.ajax({
                    url: apiUrl,
                    method: "GET",
                    headers: { "Accept": "application/json; odata=verbose" },
                    success: function (data) {
                        var score = 0;
                        if (data.d.results.length > 0) {
                            var lookedUpValue = data.d.results[0].Value;
                            var parsedValue = parseFloat(String(lookedUpValue).trim());
                            if (!isNaN(parsedValue)) {
                                score = parsedValue;
                            }
                        }
                        fd.field(targetFieldName).value(score);
                    },
                    error: function (error) {
                        console.log("Error looking up rating: " + JSON.stringify(error));
                        fd.field(targetFieldName).value(0);
                    }
                });
            }

            // --- SETUP SCORE FIELDS ---

            // 1. For Compliance / Quality
            fd.field('Compliance / Quality').$on('change', function() {
                getRating('Compliance / Quality', 'Compliance / Quality', 'CompQualScoreCalc');
            });
            getRating('Compliance / Quality', 'Compliance / Quality', 'CompQualScoreCalc');

            // 2. For Performance
            fd.field('Performance').$on('change', function() {
                getRating('Performance', 'Performance', 'PerfScoreCalc');
            });
            getRating('Performance', 'Performance', 'PerfScoreCalc');
            
            // 3. For Contract Mod
            fd.field('Contract Mod').$on('change', function() {
                getRating('Contract Mod', 'Contract Mod', 'ContractModScoreCalc');
            });
            getRating('Contract Mod', 'Contract Mod', 'ContractModScoreCalc');

            // 4. For Growth
            fd.field('Growth').$on('change', function() {
                getRating('Growth', 'Growth (Organic and New Business):', 'GrowthScoreCalc');
            });
            getRating('Growth', 'Growth (Organic and New Business):', 'GrowthScoreCalc');

			// 5. For CBA Net Cost
            fd.field('CBA Net Cost').$on('change', function() {
                getRating('CBA Net Cost', 'CBA Net Cost', 'CBANetCostScoreCalc');
            });
            getRating('CBA Net Cost', 'CBA Net Cost', 'CBANetCostScoreCalc');

            // 6. For Customer Experience
            fd.field('Customer Experience').$on('change', function() {
                getRating('Customer Experience', 'Customer Experience', 'CustExpScoreCalc');
            });
            getRating('Customer Experience', 'Customer Experience', 'CustExpScoreCalc');
        });

    } else {
        // If 'fd' is not ready, wait 100 milliseconds and try again
        setTimeout(runWhenFDReady, 100);
    }
}

// Start the process
runWhenFDReady();
