(function () {
  
  var LOOKUP_FIELD_CAPTION   = "Project";               
  var REST_SECTION_TITLE     = "Rest of Form";          
  var ID_TARGET_CAPTION      = "Project ID (copy)";     
  var STATUS_TARGET_CAPTION  = "Project Status (copy)";
  var PROJECT_LIST_TITLE     = "Project Names";         
  var STATUS_INTERNAL_NAME   = "Status";                
  
  // Grab handles
  var project    = infowiseForm.getField(LOOKUP_FIELD_CAPTION);
  var restSect   = infowiseForm.getSection(REST_SECTION_TITLE);
  var idField    = infowiseForm.getField(ID_TARGET_CAPTION);
  var statusField= infowiseForm.getField(STATUS_TARGET_CAPTION); 
  var saveBtn    = infowiseForm.getButton("Save"); 
  var addNewBtn  = infowiseForm.getButton("Add New"); 


  function setVisible(v){ if(restSect && restSect.setVisible) restSect.setVisible(!!v); }
  function setReadOnly(v){ if(restSect && restSect.setReadOnly) restSect.setReadOnly(!!v); }
  function setId(v){ if(idField && idField.setValue) idField.setValue(v != null ? String(v) : ""); }
  function setStatus(v){ if(statusField && statusField.setValue) statusField.setValue(v || ""); }
  function setButtonsEnabled(v){
    if (saveBtn && saveBtn.setEnabled) saveBtn.setEnabled(!!v);
    if (addNewBtn && addNewBtn.setEnabled) addNewBtn.setEnabled(!!v);
  }


  function applyStatusRules(statusText){
    var s = (statusText || "").toLowerCase();
    if (s === "draft" || s === "inactive") {
      setVisible(false);
      setButtonsEnabled(false);
    } else if (s === "closed") {
      setVisible(true);
      setReadOnly(true);
      setButtonsEnabled(true);
    } else {
      // Active / anything else
      setVisible(true);
      setReadOnly(false);
      setButtonsEnabled(true);
    }
  }


  function updateUI(){
    if (!project || !project.getLookupId) return;


    var projId = project.getLookupId();
    setId(projId || "");


    // No selection yet
    if (!projId){
      setVisible(false);
      setReadOnly(false);
      setStatus("");
      setButtonsEnabled(false);
      return;
    }


    // Show by default once we have a selection
    setVisible(true);
    setReadOnly(false);
    setButtonsEnabled(true);


    // 
    if (!statusField) return; // if you didn't add a status display field, we're done


    var url = _spPageContextInfo.webAbsoluteUrl +
      "/_api/web/lists/getbytitle('" + encodeURIComponent(PROJECT_LIST_TITLE) + "')/items(" + projId + ")?" +
      "$select=ID," + STATUS_INTERNAL_NAME;


    fetch(url, { headers: { "Accept": "application/json;odata=nometadata" } })
      .then(function(r){ return r.ok ? r.json() : Promise.reject(r.statusText); })
      .then(function(d){
        var status = d[STATUS_INTERNAL_NAME] || "";
        setStatus(status);
        applyStatusRules(status);
      })
      .catch(function(){
        setStatus("");
      });
  }


  updateUI();
  if (project && project.onChange) project.onChange(updateUI);
})();




-----------


(function () {
  // smoke test
  alert("Open script fired");


  // disable Save to *see* code run even if alerts are blocked
  try {
    var saveBtn = infowiseForm && infowiseForm.getButton && infowiseForm.getButton("Save");
    if (saveBtn && saveBtn.setEnabled) saveBtn.setEnabled(false);
  } catch (e) { /* ignore */ }
})();
