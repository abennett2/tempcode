(function() {
    'use strict';

    // --- CONFIGURATION ---
    const CONFIG = {
        // The name of the list you are looking up to.
        sourceListName: "Project Names",
        
        // The INTERNAL name of the status column in that list.
        statusColumnInternalName: "Status",
        
        // The status value you want to see (e.g., "Active").
        statusToKeep: "Active",
        
        // The CSS selector for your Project lookup dropdown on the form.
        projectLookupSelector: "REPLACE_WITH_YOUR_PROJECT_DROPDOWN_SELECTOR"
    };
    // --- END CONFIGURATION ---

    const projectDropdown = document.querySelector(CONFIG.projectLookupSelector);

    if (!projectDropdown) {
        // This check is kept as a safety measure.
        console.error("Ultimate Forms Script: Could not find the Project Lookup dropdown.");
        return;
    }

    /**
     * Fetches active projects from the source list and populates the dropdown.
     */
    async function populateFilteredLookup() {
        const originalFirstOption = projectDropdown.options[0];
        projectDropdown.innerHTML = ''; // Clear existing options
        if (originalFirstOption) {
            projectDropdown.appendChild(originalFirstOption);
        }
        
        try {
            const apiUrl = `/_api/web/lists/getbytitle('${CONFIG.sourceListName}')/items?$select=Id,Title&$filter=${CONFIG.statusColumnInternalName} eq '${CONFIG.statusToKeep}'&$orderby=Title`;
            
            const response = await fetch(apiUrl, {
                headers: { "Accept": "application/json;odata=verbose" }
            });

            if (!response.ok) {
                throw new Error(`SharePoint API Error: ${response.statusText}`);
            }

            const data = await response.json();
            const items = data.d.results;

            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.Id;
                option.text = item.Title;
                projectDropdown.appendChild(option);
            });

        } catch (error) {
            console.error("Failed to populate filtered lookup:", error);
        }
    }

    // --- SCRIPT EXECUTION (REVISED) ---
    // A simple timeout is a more reliable way to ensure the form is ready
    // before our script tries to modify it.
    setTimeout(populateFilteredLookup, 500); // Run after a 500ms delay
    
})();
